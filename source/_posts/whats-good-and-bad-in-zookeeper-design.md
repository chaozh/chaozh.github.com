title: Zookeeper系统的优点与不足
date: 2015-08-29 10:00:11
tags:
- zookeeper
- paxos
categories:
  - 系统经验
---

Zookeeper系统应用越来越广泛，在同一领域内开源软件方面基本没有其他选择处于垄断地位，但是实际用过的人都会觉得这个软件属于可用但又不那么好用的类型。本文是本人结合自己的实际使用经验与思考，同时参考真正大牛对这个系统的分析与评价进行的总结，主要还是想归纳一下真正的使用需求并思考相应对策与改进的办法。

##1.常见应用场景

先归纳一下工程应用中常见的Zookeeper使用场景（以下简称ZK），这里按照个人感觉应用的频率从高到低排序说明。
	
1. 可靠存储
	
	在实际使用中可以表现为配置管理、名字服务，这种应用完全是因为ZK多备份的可靠性强。当然也可以利用回调机制在数据变更时可以进行全体通知。实现起来非常简单而且很有效，所以是应用最广的场景。
	
2. 集群管理
	
	利用ZK的通讯与回调机制完成分布式集群的机器状态监视，甚至很多系统中做主从备份时都会在ZK中注册以方便做热备切换。
	
2. 服务注册发现管理

	由可靠存储加上通知回调机制其实满足了服务注册发现的最基本需求，某些在本人看起来不那么靠谱的应用场景，居然也在采用ZK实现。大有一统天下之势，所有类似的需求都开始采用ZK方案，比较出名的系统比如国内的Dubbo和国外的Kafka(居然还把ZK用在了负载均衡上面)、jStorm、Heron(twitter)等等

3. 选主服务
	
	选主服务是ZK参考的原始系统Chubby设计出来最本初的应用需求，当时是满足BigTable的master选主。ZK最初也是用在HBase里面，而后所有需要选主服务的都在采用，很多KV系统用来方便从多节点中选择一个中心节点（但是本人还真没找到什么）。	
	需要注意的是有时选主服务在讨论里也被称为分布式锁的一种，很容易混淆概念。的确使用ZK来实现选主服务(实现方法最好跟分布式锁的方法完全一样，这里官方文档都曾经犯过错误)客观上遵循了时间优先原则，但是实际需求并非一定要满足这条，只要保证关键的唯一性就可以了，因此与同步意义上的锁很是有不同的。

4. 分布式同步机制
 	
 	即真正的分布式锁，但是实际应用并不常见。本人实现过几次，目前准备运用在表单提交的同步上。

##2.特性设计与优势

ZK这么受欢迎是因为其灵活的设计满足了很多种需求，同样将特性的受欢迎程度按照个人感觉从高到低进行说明

1. 通知回调机制

	方便的回调
	
2. 可靠存储
3. 节点状态
4. 文件系统模型

##3.实现技术选择与优点

详述这些优点的来源，与设计思路

1. 通讯机制与状态的实现
2. Zab协议与Paxos
3. 使用JVM

##4.实际使用暴露的不足
回答Zookeeper使用时还有哪些问题

1. API使用复杂
2. 实际客户端逻辑复杂
3. ZK异常状态判断
4. 回调次数限制
5. Zab协议与全系统的有效性（能否避免脑裂发生）
6. 服务极限与可扩展性
7. 存储极限与可扩展性
8. 性能（不算问题的问题）

##5.需求满足缺陷

设计层面上的不足

1. 事务API能力不足
2. 中心的仲裁能力
3. 回调次数
4. 可扩展性

##6. 怎样更好的设计？

1. 更丰富有效的API
2. 委托服务端处理能力
3. 可扩展性
4. JVM

##7. 参考资料
[可靠消息队列浅谈](http://blog.buaa.us/talk-about-mq/)
[为什么不应该使用ZooKeeper做服务发现](http://dockone.io/article/78)
[持续可用与CAP理论 – 一个系统开发者的观点](http://www.nosqlnotes.net/archives/333)
[Kafka深度解析](http://www.jasongj.com/2015/01/02/Kafka%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/)
[Zookeeper架构设计与应用要点](http://shiyanjun.cn/archives/474.html)